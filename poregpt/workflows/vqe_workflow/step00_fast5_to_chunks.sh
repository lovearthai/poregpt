#!/bin/bash

# ============================================================================
# ËÑöÊú¨ÂêçÁß∞: step00_fast5_to_chunks_dna.sh
# ÂäüËÉΩ:     ‰ΩøÁî® DATASET_DIR Áªü‰∏ÄÁÆ°ÁêÜÊï∞ÊçÆÊ†πÁõÆÂΩïÔºåÊòæÂºèÊò†Â∞Ñ FAST5 ‚Üí ËæìÂá∫ÁõÆÂΩï„ÄÇ
# Ê≥®ÊÑè:     ‰æùËµñÂ∑≤ÂÆâË£ÖÁöÑ nanopore_llm_workflow ÂåÖÔºàÊèê‰æõ fast5-to-chunks ÂëΩ‰ª§Ôºâ
# ============================================================================

# ----------------------------------------------------------------------------
# Ê†∏ÂøÉÈÖçÁΩÆÔºöÊï∞ÊçÆÈõÜÊ†πÁõÆÂΩï
# ----------------------------------------------------------------------------
DATASET_DIR="/mnt/nas_syy/default/huada_signal_llm/dataset/dna/human_min0_max2_read96655"

# ----------------------------------------------------------------------------
# ËæìÂÖ•-ËæìÂá∫Êò†Â∞ÑÔºàÂü∫‰∫é DATASET_DIR ÊûÑÂª∫Ôºâ
#   - ÊØè‰∏™ FAST5 Â≠êÁõÆÂΩïÂØπÂ∫î‰∏Ä‰∏™ chunk ËæìÂá∫Â≠êÁõÆÂΩï
#   - ÂëΩÂêçÁ∫¶ÂÆöÔºötrain ‚Üí train2, test ‚Üí test2ÔºàÈÅøÂÖçË¶ÜÁõñÊóßÊï∞ÊçÆÔºâ
# ----------------------------------------------------------------------------
FAST5_DIRS=(
    "$DATASET_DIR/fast5/train"
    "$DATASET_DIR/fast5/test"
    "$DATASET_DIR/fast5/validation"
)

OUTPUT_DIRS=(
    "$DATASET_DIR/chunk/train2"
    "$DATASET_DIR/chunk/test2"
    "$DATASET_DIR/chunk/validation2"
)

# Ê£ÄÊü•Êï∞ÁªÑÈïøÂ∫¶ÊòØÂê¶‰∏ÄËá¥ÔºàÈò≤Ê≠¢ÈÖçÁΩÆÈîô‰ΩçÔºâ
if [ "${#FAST5_DIRS[@]}" -ne "${#OUTPUT_DIRS[@]}" ]; then
    echo "‚ùå Error: Number of FAST5_DIRS != OUTPUT_DIRS"
    exit 1
fi

# ----------------------------------------------------------------------------
# ‰ø°Âè∑Â§ÑÁêÜÊ†∏ÂøÉÂèÇÊï∞Ôºà‰∏é Fast5Dir.to_chunks() ÂÆåÂÖ®ÂØπÈΩêÔºâ
# ÂèÇËÄÉ: nanopore_signal_tokenizer/utils/fast5.py
# ----------------------------------------------------------------------------

# „ÄêChunking„ÄëÊØè‰∏™‰ø°Âè∑ÁâáÊÆµÁöÑÈïøÂ∫¶ÔºàÂçï‰ΩçÔºöÈááÊ†∑ÁÇπÔºâ
# ÂçéÂ§ß DNA ÊµãÂ∫èÈªòËÆ§ÈááÊ†∑Áéá 5000 HzÔºå12000 ÁÇπ ‚âà 2.4 Áßí‰ø°Âè∑
WINDOW_SIZE=12000

# „ÄêChunking„ÄëÊªëÂä®Á™óÂè£Ê≠•ÈïøÔºàÂçï‰ΩçÔºöÈááÊ†∑ÁÇπÔºâ
# STRIDE = WINDOW_SIZE - overlapÔºõÊ≠§Â§Ñ overlap = 60 ÁÇπÔºà‚âà12msÔºâ
STRIDE=11940

# „ÄêÂΩí‰∏ÄÂåñ„ÄëÊòØÂê¶ÂêØÁî® median-MAD ÂΩí‰∏ÄÂåñÔºàÂº∫ÁÉàÂª∫ËÆÆÂºÄÂêØÔºâ
DO_NORMALIZE="true"

# „ÄêÊª§Ê≥¢„ÄëÊòØÂê¶ÂêØÁî®‰∏≠ÂÄºÊª§Ê≥¢Ôºàkernel=5ÔºâÔºåÁî®‰∫éÂéªÈô§ spike Âô™Â£∞
# Ê≥®ÊÑèÔºöfast5.py ‰∏≠ medfilt ÊòØÁ°¨ÁºñÁ†ÅÂ∫îÁî®ÁöÑÔºå‰ΩÜ CLI ‰ªç‰øùÁïôÂºÄÂÖ≥ÔºàÊú™Êù•ÂèØËÉΩËß£ËÄ¶Ôºâ
DO_MEDIANFILTER="true"

# „ÄêÊª§Ê≥¢„ÄëÊòØÂê¶ÂêØÁî® Butterworth ‰ΩéÈÄöÊª§Ê≥¢ÔºàÈªòËÆ§ÂÖ≥Èó≠ÔºåÂõ†ÂèØËÉΩÂºïÂÖ•Áõ∏‰ΩçÂ§±ÁúüÔºâ
DO_LOWPASSFILTER="false"

# „ÄêËÆæÂ§á„ÄëÈªòËÆ§ÈááÊ†∑ÁéáÔºàHzÔºâÔºåÂΩì FAST5 metadata Áº∫Â§±Êó∂‰ΩøÁî®
# ÂçéÂ§ßÊµãÂ∫è‰ª™Ê†áÂáÜÈááÊ†∑ÁéáÔºö5000 Hz
DEFAULT_FS=5000

# „ÄêÊÄßËÉΩ„ÄëÂπ∂Ë°åËøõÁ®ãÊï∞Ôºà-1 Ë°®Á§∫ÂÖ®ÈÉ® CPUÔºåÊ≠§Â§ÑÊòæÂºèËÆæ‰∏∫ 64Ôºâ
# Âª∫ËÆÆ ‚â§ Áâ©ÁêÜÊ†∏ÂøÉÊï∞ÔºåÈÅøÂÖç I/O Áì∂È¢à
N_JOBS=64

# „ÄêÂ§öÂ§¥Ë£ÅÂâ™„ÄëÊúÄÂ§ßÂºÄÂ§¥Ë£ÅÂâ™ÈïøÂ∫¶ÔºàinclusiveÔºâÔºåÁî®‰∫éÁîüÊàê stride ÂØπÈΩêÁöÑÂ§öÁõ∏‰ΩçËæìÂÖ•
# ‰æãÂ¶ÇÔºöËã•‰∏ãÊ∏∏ CNN ‰∏ãÈááÊ†∑ stride=4ÔºåÂàô cut_head_all=3 ÂèØË¶ÜÁõñ 0,1,2,3 ÂõõÁßçËµ∑ÂßãÂÅèÁßª
CUT_HEAD_ALL=3

# „ÄêÂ§öÂ§¥Ë£ÅÂâ™„ÄëË£ÅÂâ™Ê≠•ÈïøÔºåÊéßÂà∂Áõ∏‰ΩçÂØÜÂ∫¶
# step=2 ‚Üí ÁîüÊàê head_cut = 0, 2ÔºàÂÖ± 2 ÁßçÁõ∏‰ΩçÔºâ
CUT_HEAD_STEP=2

# „ÄêÊú´Â∞æÂÖúÂ∫ï„ÄëËß¶ÂèëÊú´Â∞æË°• chunk ÁöÑÊúÄÂ∞èÂâ©‰ΩôÈïøÂ∫¶ÔºàÂçï‰ΩçÔºöÈááÊ†∑ÁÇπÔºâ
# Ëã•ÊªëÂä®ÁªìÊùüÂêéÂâ©‰Ωô ‚â• TAIL_THRESHOLDÔºåÂàô‰ªéÊú´Â∞æÂº∫Âà∂ÂàáÂá∫‰∏Ä‰∏™ÂÆåÊï¥ window
# ËÆæÁΩÆËøáÂ∞è‰ºöÂØºËá¥ÈáçÂ§ç chunkÔºåËøáÂ§ßÂàôÊµ™Ë¥πÂ∞æÈÉ®‰ø°Âè∑
TAIL_THRESHOLD=150

# ----------------------------------------------------------------------------
# ‰ø°Âè∑ËåÉÂõ¥Ë£ÅÂâ™ÂèÇÊï∞ÔºàÁî®‰∫éÂºÇÂ∏∏ÂÄºËøáÊª§Ôºâ
# ÂèÇËÄÉÂçéÂ§ßÂ∑•Á®ãÂ∏àÂèçÈ¶àÔºöDNA ÂºÄÂ≠îÁîµÊµÅÁ®≥ÂÆöÔºåÂÖ∏ÂûãËåÉÂõ¥ [90, 220] pA
# ‰ΩÜ‰∏∫È≤ÅÊ£íÊÄßÔºåÊîæÂÆΩËá≥ [1, 220] pA
# ----------------------------------------------------------------------------

# „ÄêÂéüÂßã‰ø°Âè∑„Äë‰Ωé‰∫éÊ≠§ÂÄºÔºàpAÔºâËßÜ‰∏∫ÂºÇÂ∏∏ÔºàÂ¶Ç gating Âç°È°øÔºâ
# ÂçéÂ§ßÂª∫ËÆÆÔºöDNA ‰∏çÂÜôÊ≠ªÂºÄÂ≠îÁîµÊµÅÔºå‰ΩÜÂèØËÆæ‰∏ãÈôê‰∏∫ 1 pAÔºàÈÅøÂÖçË¥üÂÄº/Èõ∂ÂÄºÔºâ
SIGNAL_MIN_VALUE=1

# „ÄêÂéüÂßã‰ø°Âè∑„ÄëÈ´ò‰∫éÊ≠§ÂÄºÔºàpAÔºâËßÜ‰∏∫ÂºÇÂ∏∏ÔºàÂ¶ÇÁîµÊûÅÂô™Â£∞Ôºâ
# ÂçéÂ§ß RNA/DNA ÂºÄÂ≠îÁîµÊµÅÂÖ∏Âûã‰∏äÈôê‰∏∫ 220 pA
SIGNAL_MAX_VALUE=220

# ----------------------------------------------------------------------------
# ÂΩí‰∏ÄÂåñÂêé‰ø°Âè∑ËåÉÂõ¥ÔºàÁî®‰∫éË¥®ÈáèÊéßÂà∂Ôºâ
# ÂΩí‰∏ÄÂåñÂêé‰ø°Âè∑ÁêÜËÆ∫‰∏äÂ∫îËêΩÂú® [-5, 5] Êàñ [-9, 9] ÂÜÖ
# Ëã•Ë∂ÖÂá∫ÔºåËØ¥ÊòéÂ≠òÂú®Êú™‰øÆÂ§çÁöÑÊûÅÁ´ØÂºÇÂ∏∏ÔºåËØ• read Â∞ÜË¢´Ë∑≥Ëøá
# ----------------------------------------------------------------------------

# „ÄêÂΩí‰∏ÄÂåñ‰ø°Âè∑„ÄëÂÖÅËÆ∏ÁöÑÊúÄÂ∞èÂÄºÔºàMAD Âçï‰ΩçÔºâ
NORMAL_MIN_VALUE=-9

# „ÄêÂΩí‰∏ÄÂåñ‰ø°Âè∑„ÄëÂÖÅËÆ∏ÁöÑÊúÄÂ§ßÂÄºÔºàMAD Âçï‰ΩçÔºâ
NORMAL_MAX_VALUE=9

# ----------------------------------------------------------------------------
# ÊûÑÂª∫ÈÄöÁî®ÂèÇÊï∞ÔºàËΩ¨Êç¢Â∏ÉÂ∞îÂÄº‰∏∫ CLI ÂèÇÊï∞Ôºâ
# ----------------------------------------------------------------------------

if [ "$DO_NORMALIZE" = "true" ]; then
    NORMALIZE_ARG="--do_normalize"
else
    NORMALIZE_ARG="--no_normalize"
fi

MEDIANFILTER_ARG=""
[ "$DO_MEDIANFILTER" = "true" ] && MEDIANFILTER_ARG="--do_medianfilter"

LOWPASSFILTER_ARG=""
[ "$DO_LOWPASSFILTER" = "true" ] && LOWPASSFILTER_ARG="--do_lowpassfilter"

# ----------------------------------------------------------------------------
# Âæ™ÁéØÂ§ÑÁêÜÊØè‰∏ÄÂØπ (fast5_dir, output_dir)
# ----------------------------------------------------------------------------
for i in "${!FAST5_DIRS[@]}"; do
    FAST5_DIR="${FAST5_DIRS[$i]}"
    OUTPUT_DIR="${OUTPUT_DIRS[$i]}"

    if [ ! -d "$FAST5_DIR" ]; then
        echo "‚ö†Ô∏è  Warning: FAST5 directory not found: $FAST5_DIR. Skipping..."
        continue
    fi

    echo "================================================================"
    echo "üöÄ Processing: $FAST5_DIR"
    echo "üìÅ Output to:  $OUTPUT_DIR"
    echo "================================================================"

    mkdir -p "$OUTPUT_DIR"

    # Ë∞ÉÁî®ÂÖ®Â±ÄÂëΩ‰ª§ÔºàÁî± pyproject.toml [project.scripts] ÂÆö‰πâÔºâ
    # ÂÆûÈôÖË∞ÉÁî®: nanopore_llm_workflow.cli.fast5.fast5_to_chunks:main
    CMD=(
        nanopore_llm_workflow-fast5-to-chunks  # ‚Üê Ê≥®ÊÑèÔºöÂëΩ‰ª§ÂêçÊòØ fast5-to-chunksÔºå‰∏çÊòØ nanopore_llm_workflow-fast5-to-chunks
        --fast5_dir "$FAST5_DIR"
        --output_dir "$OUTPUT_DIR"
        --window_size "$WINDOW_SIZE"
        --stride "$STRIDE"
        $NORMALIZE_ARG
        $MEDIANFILTER_ARG
        $LOWPASSFILTER_ARG
        --default_fs "$DEFAULT_FS"
        --n_jobs "$N_JOBS"
        --cut_head_all "$CUT_HEAD_ALL"
        --cut_head_step "$CUT_HEAD_STEP"
        --tail_threshold "$TAIL_THRESHOLD"
        --signal_min_value "$SIGNAL_MIN_VALUE"
        --signal_max_value "$SIGNAL_MAX_VALUE"
        --normal_min_value "$NORMAL_MIN_VALUE"
        --normal_max_value "$NORMAL_MAX_VALUE"
    )

    echo ">>> Running command:"
    printf "%q " "${CMD[@]}"
    echo
    echo "--------------------------------------------------"

    "${CMD[@]}"

    if [ $? -eq 0 ]; then
        echo "‚úÖ Success: $FAST5_DIR ‚Üí $OUTPUT_DIR"
    else
        echo "‚ùå Failed: $FAST5_DIR"
        exit 1
    fi
    echo
done

echo "üéâ All preprocessing completed."
