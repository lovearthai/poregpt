#!/bin/bash

# ============================================================================
# 脚本名称: run_preprocess.sh
# 功能:     调用 Python 脚本 step01_fast5_to_chunks.py，对 Nanopore FAST5 原始信号进行预处理。
#          将 .fast5 文件转换为归一化后的固定长度信号片段（.npy 文件），
#          用于后续 LLM 或深度学习模型训练。
#
# 依赖:
#   - Python 3.8+
#   - 已安装 nanopore_llm_workflow 包（通过 pip install -e . 安装）
#   - scripts/step01_fast5_to_chunks.py 存在
#
# 作者:     Your Name
# 日期:     2025-06-10
# ============================================================================


# ----------------------------------------------------------------------------
# 设置脚本所在项目的 scripts 目录（根据你的设定固定为 "scripts"）
# 注意：你已硬编码 SCRIPT_DIR="scripts"，所以假设此脚本从项目根目录运行
# ----------------------------------------------------------------------------
SCRIPT_DIR="scripts"


# ----------------------------------------------------------------------------
# 配置区：所有可调参数集中在此处，便于修改和版本控制。
# 每个变量对应 Python 脚本中的一个命令行参数。
# ----------------------------------------------------------------------------

FAST5_DIR="./fast5"
OUTPUT_DIR="./fast5_chunks_w12k"
WINDOW_SIZE=12000
STRIDE=11900
DO_NORMALIZE="true"
DO_MEDIANFILTER="true"
DO_LOWPASSFILTER="false"
DEFAULT_FS=5000
N_JOBS=40


# ----------------------------------------------------------------------------
# 构建 normalize 参数
# 修复点 1: 原脚本缺少 else 分支，若 DO_NORMALIZE="false" 会导致 NORMALIZE_ARG 未定义
# ----------------------------------------------------------------------------
if [ "$DO_NORMALIZE" = "true" ]; then
    NORMALIZE_ARG="--do_normalize"
else
    NORMALIZE_ARG="--no_normalize"
fi


# ----------------------------------------------------------------------------
# 构建中值滤波参数
# 修复点 2: 原脚本错误地将 MEDIANFILTER_ARG 初始化为 "false"（字符串），应为空
# ----------------------------------------------------------------------------
MEDIANFILTER_ARG=""
if [ "$DO_MEDIANFILTER" = "true" ]; then
    MEDIANFILTER_ARG="--do_medianfilter"
fi


# ----------------------------------------------------------------------------
# 构建低通滤波参数
# 同样修复初始化问题
# ----------------------------------------------------------------------------
LOWPASSFILTER_ARG=""
if [ "$DO_LOWPASSFILTER" = "true" ]; then
    LOWPASSFILTER_ARG="--do_lowpassfilter"
fi


# ----------------------------------------------------------------------------
# 构造完整的命令行（用于打印和执行）
# 使用数组避免空格/引号问题（更健壮）
# ----------------------------------------------------------------------------
CMD=(
    python3 "$SCRIPT_DIR/step01_fast5_to_chunks.py"
    --fast5_dir "$FAST5_DIR"
    --output_dir "$OUTPUT_DIR"
    --window_size "$WINDOW_SIZE"
    --stride "$STRIDE"
    $NORMALIZE_ARG
    $MEDIANFILTER_ARG
    $LOWPASSFILTER_ARG
    --default_fs "$DEFAULT_FS"
    --n_jobs "$N_JOBS"
)


# ----------------------------------------------------------------------------
# 打印命令（用于调试）
# 使用 printf "%q" 安全转义参数，确保可直接复制粘贴运行
# ----------------------------------------------------------------------------
echo ">>> Running command:"
printf "%q " "${CMD[@]}"
echo  # 换行
echo "--------------------------------------------------"


# ----------------------------------------------------------------------------
# 执行命令
# 如果命令失败（非零退出码），脚本会立即终止（可选：加上 set -e 更严格）
# ----------------------------------------------------------------------------
"${CMD[@]}"


# ----------------------------------------------------------------------------
# 成功提示
# ----------------------------------------------------------------------------
echo "Preprocessing completed."
